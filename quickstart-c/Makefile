# GNU Make workspace makefile autogenerated by Premake

# Disable implicit rules to prevent "tangle" error on macOS with Makefile.web
.SUFFIXES:

ifndef config
  config=debug_x64
endif

ifndef verbose
  SILENT = @
endif

ifeq ($(config),debug_x64)
  raylib_quickstart_config = debug_x64
  raylib_config = debug_x64

else ifeq ($(config),debug_x86)
  raylib_quickstart_config = debug_x86
  raylib_config = debug_x86

else ifeq ($(config),debug_arm64)
  raylib_quickstart_config = debug_arm64
  raylib_config = debug_arm64

else ifeq ($(config),release_x64)
  raylib_quickstart_config = release_x64
  raylib_config = release_x64

else ifeq ($(config),release_x86)
  raylib_quickstart_config = release_x86
  raylib_config = release_x86

else ifeq ($(config),release_arm64)
  raylib_quickstart_config = release_arm64
  raylib_config = release_arm64

else
  $(error "invalid configuration $(config)")
endif

PROJECTS := raylib-quickstart raylib

.PHONY: all clean help run dmg $(PROJECTS) 

all: $(PROJECTS)

raylib-quickstart: raylib
ifneq (,$(raylib_quickstart_config))
	@echo "==== Building raylib-quickstart ($(raylib_quickstart_config)) ===="
	@${MAKE} --no-print-directory -C build/build_files -f raylib-quickstart.make config=$(raylib_quickstart_config)
	@# Rename executable to match APP_NAME
	@if [ -f "bin/$(BUILD_CONFIG)/raylib-quickstart" ]; then \
		mv "bin/$(BUILD_CONFIG)/raylib-quickstart" "$(EXECUTABLE)"; \
		echo "Renamed executable to $(APP_NAME)"; \
	fi
endif

raylib:
ifneq (,$(raylib_config))
	@echo "==== Building raylib ($(raylib_config)) ===="
	@${MAKE} --no-print-directory -C build/build_files -f raylib.make config=$(raylib_config)
endif

clean:
	@${MAKE} --no-print-directory -C build/build_files -f raylib-quickstart.make clean
	@${MAKE} --no-print-directory -C build/build_files -f raylib.make clean
	@rm -f "$(EXECUTABLE)"
	@rm -rf "$(APP_BUNDLE)"
	@rm -f "$(DMG_NAME)" "$(DMG_WRITABLE)" "$(ICON_ICNS)"

# Extract build configuration (Debug/Release) from config
ifeq ($(findstring debug,$(config)),debug)
  BUILD_CONFIG = Debug
else ifeq ($(findstring release,$(config)),release)
  BUILD_CONFIG = Release
else
  BUILD_CONFIG = Debug
endif

# Application metadata from application.rc
APP_NAME = raylib-quickstart-c
PRODUCT_NAME = raylib-quickstart-c
PRODUCT_VERSION = 1.0.0
BUNDLE_ID = com.mintricksai.raylib-quickstart-c
COPYRIGHT = (c) 2025 Nicolas Brooks, Mintricks AI

# Paths
EXECUTABLE = bin/$(BUILD_CONFIG)/$(APP_NAME)
APP_BUNDLE = $(PRODUCT_NAME).app
CONTENTS_DIR = $(APP_BUNDLE)/Contents
MACOS_DIR = $(CONTENTS_DIR)/MacOS
RESOURCES_DIR = $(CONTENTS_DIR)/Resources
DMG_NAME = $(APP_NAME).dmg
DMG_WRITABLE = $(APP_NAME)_writeable.dmg
ICON_ICO = resources/app-icon.ico
ICON_ICNS = resources/app-icon.icns
ICON_NAME = app-icon

# Version from project.conf
VERSION := $(shell grep '^VERSION=' project.conf | cut -d= -f2)
ifeq ($(VERSION),)
  VERSION := latest
endif
S3_BASE_PATH = s3://dev-nicapotato-user-content/games/quickstart-c/$(VERSION)/mac-arm64

dmg: raylib-quickstart
	@echo "==== Creating macOS DMG package ===="
	@if [ ! -f "$(EXECUTABLE)" ]; then \
		echo "Error: Executable not found at $(EXECUTABLE)"; \
		echo "Please build the project first with: make config=$(config)"; \
		exit 1; \
	fi
	@echo "Building DMG from $(BUILD_CONFIG) configuration..."
	@# Clean up any existing bundle
	@rm -rf "$(APP_BUNDLE)"
	@# Create bundle structure
	@mkdir -p "$(MACOS_DIR)"
	@mkdir -p "$(RESOURCES_DIR)"
	@# Copy executable
	@cp "$(EXECUTABLE)" "$(MACOS_DIR)/$(APP_NAME)"
	@chmod +x "$(MACOS_DIR)/$(APP_NAME)"
	@# Copy resources to multiple locations so SearchAndSetResourceDir can find them
	@if [ -d "resources" ]; then \
		cp -r resources "$(RESOURCES_DIR)/"; \
		cp -r resources "$(MACOS_DIR)/"; \
	fi
	@# Also copy resources from bin directory if they exist (for release builds)
	@if [ -d "$(shell dirname $(EXECUTABLE))/resources" ]; then \
		cp -r "$(shell dirname $(EXECUTABLE))/resources" "$(RESOURCES_DIR)/" 2>/dev/null || true; \
		cp -r "$(shell dirname $(EXECUTABLE))/resources" "$(MACOS_DIR)/" 2>/dev/null || true; \
	fi
	@# Convert icon from .ico to .icns for macOS
	@if [ -f "$(ICON_ICO)" ]; then \
		echo "Converting icon to .icns format..."; \
		if sips -s format icns "$(ICON_ICO)" --out "$(ICON_ICNS)" > /dev/null 2>&1; then \
			echo "Icon converted successfully"; \
		else \
			echo "Warning: Direct conversion failed. Creating iconset..."; \
			ICONSET_DIR=$$(mktemp -d)/$(ICON_NAME).iconset; \
			mkdir -p "$$ICONSET_DIR"; \
			trap "rm -rf $$(dirname $$ICONSET_DIR)" EXIT; \
			sips -z 16 16 "$(ICON_ICO)" --out "$$ICONSET_DIR/icon_16x16.png" > /dev/null 2>&1; \
			sips -z 32 32 "$(ICON_ICO)" --out "$$ICONSET_DIR/icon_16x16@2x.png" > /dev/null 2>&1; \
			sips -z 32 32 "$(ICON_ICO)" --out "$$ICONSET_DIR/icon_32x32.png" > /dev/null 2>&1; \
			sips -z 64 64 "$(ICON_ICO)" --out "$$ICONSET_DIR/icon_32x32@2x.png" > /dev/null 2>&1; \
			sips -z 128 128 "$(ICON_ICO)" --out "$$ICONSET_DIR/icon_128x128.png" > /dev/null 2>&1; \
			sips -z 256 256 "$(ICON_ICO)" --out "$$ICONSET_DIR/icon_128x128@2x.png" > /dev/null 2>&1; \
			sips -z 256 256 "$(ICON_ICO)" --out "$$ICONSET_DIR/icon_256x256.png" > /dev/null 2>&1; \
			sips -z 512 512 "$(ICON_ICO)" --out "$$ICONSET_DIR/icon_256x256@2x.png" > /dev/null 2>&1; \
			sips -z 512 512 "$(ICON_ICO)" --out "$$ICONSET_DIR/icon_512x512.png" > /dev/null 2>&1; \
			sips -z 1024 1024 "$(ICON_ICO)" --out "$$ICONSET_DIR/icon_512x512@2x.png" > /dev/null 2>&1; \
			if iconutil -c icns "$$ICONSET_DIR" -o "$(ICON_ICNS)" 2>/dev/null; then \
				echo "Icon converted via iconset"; \
			else \
				echo "Warning: Icon conversion failed, app will use default icon"; \
			fi; \
			rm -rf "$$(dirname $$ICONSET_DIR)"; \
		fi; \
		if [ -f "$(ICON_ICNS)" ]; then \
			cp "$(ICON_ICNS)" "$(RESOURCES_DIR)/$(ICON_NAME).icns"; \
			echo "Icon copied to app bundle"; \
		fi; \
	fi
	@# Create Info.plist
	@echo '<?xml version="1.0" encoding="UTF-8"?>' > "$(CONTENTS_DIR)/Info.plist"
	@echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '<plist version="1.0">' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '<dict>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<key>CFBundleExecutable</key>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<string>$(APP_NAME)</string>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<key>CFBundleIdentifier</key>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<string>$(BUNDLE_ID)</string>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<key>CFBundleName</key>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<string>$(PRODUCT_NAME)</string>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<key>CFBundleVersion</key>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<string>$(PRODUCT_VERSION)</string>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<key>CFBundleShortVersionString</key>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<string>$(PRODUCT_VERSION)</string>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<key>CFBundlePackageType</key>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<string>APPL</string>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<key>CFBundleInfoDictionaryVersion</key>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<string>6.0</string>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<key>LSMinimumSystemVersion</key>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<string>10.9</string>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<key>NSHumanReadableCopyright</key>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '	<string>$(COPYRIGHT)</string>' >> "$(CONTENTS_DIR)/Info.plist"
	@if [ -f "$(RESOURCES_DIR)/$(ICON_NAME).icns" ]; then \
		echo '	<key>CFBundleIconFile</key>' >> "$(CONTENTS_DIR)/Info.plist"; \
		echo '	<string>$(ICON_NAME)</string>' >> "$(CONTENTS_DIR)/Info.plist"; \
	fi
	@echo '</dict>' >> "$(CONTENTS_DIR)/Info.plist"
	@echo '</plist>' >> "$(CONTENTS_DIR)/Info.plist"
	@# Sign the application bundle
	@echo "Signing app bundle..."
	@# Check if Developer ID certificate is available, otherwise use ad-hoc signing
	@if security find-identity -v -p codesigning | grep -q "Developer ID Application"; then \
		SIGN_IDENTITY=$$(security find-identity -v -p codesigning | grep "Developer ID Application" | head -1 | sed 's/.*"\(.*\)".*/\1/'); \
		echo "Using Developer ID certificate: $$SIGN_IDENTITY"; \
		codesign --force --deep --sign "$$SIGN_IDENTITY" --options runtime --timestamp "$(APP_BUNDLE)" || \
		codesign --force --deep --sign "$$SIGN_IDENTITY" --options runtime "$(APP_BUNDLE)"; \
	else \
		echo "No Developer ID certificate found, using ad-hoc signing"; \
		echo "Note: Ad-hoc signed apps may be blocked by Gatekeeper on other Macs"; \
		codesign --force --deep --sign - --options runtime "$(APP_BUNDLE)"; \
	fi
	@# Verify the signature
	@echo "Verifying app bundle signature..."
	@if codesign --verify --deep --strict --verbose=2 "$(APP_BUNDLE)" 2>&1; then \
		echo "Signature verification passed"; \
	else \
		echo "Warning: Signature verification failed or incomplete (this is normal for ad-hoc signing)"; \
	fi
	@# Check for Gatekeeper issues (informational only)
	@echo "Checking Gatekeeper status..."
	@if spctl --assess --verbose "$(APP_BUNDLE)" 2>&1 | grep -q "accepted"; then \
		echo "Gatekeeper check passed"; \
	else \
		echo "Note: Gatekeeper may block this app on other Macs without Developer ID signing"; \
	fi
	@# Clean up any existing DMG files
	@rm -f "$(DMG_NAME)" "$(DMG_WRITABLE)"
	@# Create a temporary directory with app bundle and Applications symlink
	@TEMP_DIR=$$(mktemp -d); \
	trap "rm -rf $$TEMP_DIR" EXIT; \
	cp -R "$(APP_BUNDLE)" "$$TEMP_DIR/"; \
	ln -s /Applications "$$TEMP_DIR/Applications"; \
	echo "Creating DMG image..."; \
	hdiutil create -srcfolder "$$TEMP_DIR" -volname '$(PRODUCT_NAME)' -fs HFS+ -format UDZO -o "$(DMG_NAME)" > /dev/null 2>&1 || \
	hdiutil create -srcfolder "$$TEMP_DIR" -volname '$(PRODUCT_NAME)' -fs HFS+ -format UDZO -o "$(DMG_NAME)"; \
	rm -rf "$$TEMP_DIR"; \
	echo "DMG created successfully: $(DMG_NAME)"
	@# Sign the DMG if Developer ID certificate is available
	@if security find-identity -v -p codesigning | grep -q "Developer ID Application"; then \
		SIGN_IDENTITY=$$(security find-identity -v -p codesigning | grep "Developer ID Application" | head -1 | sed 's/.*"\(.*\)".*/\1/'); \
		echo "Signing DMG with Developer ID..."; \
		codesign --sign "$$SIGN_IDENTITY" --timestamp "$(DMG_NAME)" || \
		codesign --sign "$$SIGN_IDENTITY" "$(DMG_NAME)"; \
		codesign --verify --verbose "$(DMG_NAME)" && echo "DMG signature verified"; \
	else \
		echo "DMG not signed (no Developer ID certificate found)"; \
	fi
	@echo "Generating SHA256 Checksum..."
	@shasum -a 256 "$(DMG_NAME)" > "$(DMG_NAME).sha256"
	@echo "Checksum saved to $(DMG_NAME).sha256"
	@echo ""
	@echo "==== DMG Creation Complete ===="
	@echo "File: $(DMG_NAME)"
	@if ! security find-identity -v -p codesigning | grep -q "Developer ID Application"; then \
		echo ""; \
		echo "NOTE: This DMG was created with ad-hoc signing."; \
		echo "For distribution, users may need to:"; \
		echo "  1. Right-click the app and select 'Open'"; \
		echo "  2. Or go to System Settings > Privacy & Security and click 'Open Anyway'"; \
		echo ""; \
		echo "For proper distribution, consider:"; \
		echo "  - Enrolling in Apple Developer Program (\$$99/year)"; \
		echo "  - Obtaining a Developer ID certificate"; \
		echo "  - Notarizing the app with Apple"; \
	fi

upload: dmg
	@echo "==== Uploading to S3 (Version: $(VERSION)) ===="
	@if [ ! -f "$(DMG_NAME)" ]; then \
		echo "Error: DMG not found. Please build first."; \
		exit 1; \
	fi
	@echo "Uploading to $(S3_BASE_PATH)/"
	@aws s3 cp "$(DMG_NAME)" "$(S3_BASE_PATH)/"
	@aws s3 cp "$(DMG_NAME).sha256" "$(S3_BASE_PATH)/"
	@echo "Upload complete."

run: raylib-quickstart
	@echo "==== Running $(APP_NAME) ===="
	@if [ ! -f "$(EXECUTABLE)" ]; then \
		echo "Error: Executable not found at $(EXECUTABLE)"; \
		echo "Please build the project first with: make config=$(config)"; \
		exit 1; \
	fi
	@# Ensure resources are up to date in the bin directory
	@if [ -d "resources" ]; then \
		mkdir -p "$(shell dirname $(EXECUTABLE))/resources"; \
		cp -r resources/* "$(shell dirname $(EXECUTABLE))/resources/"; \
	fi
	@echo "Running $(EXECUTABLE)..."
	@EXEC_DIR="$(shell dirname $(EXECUTABLE))"; \
	cd "$$EXEC_DIR" && ./$(APP_NAME)

help:
	@echo "Usage: make [config=name] [target]"
	@echo ""
	@echo "CONFIGURATIONS:"
	@echo "  debug_x64"
	@echo "  debug_x86"
	@echo "  debug_arm64"
	@echo "  release_x64"
	@echo "  release_x86"
	@echo "  release_arm64"
	@echo ""
	@echo "TARGETS:"
	@echo "   all (default)"
	@echo "   clean"
	@echo "   raylib-quickstart"
	@echo "   raylib"
	@echo "   run              - Build and run the application"
	@echo "   dmg              - Create macOS DMG package (macOS only)"
	@echo ""
	@echo "For more information, see https://github.com/premake/premake-core/wiki"