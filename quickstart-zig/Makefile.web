# Makefile.web
# WebAssembly build for raylib-quickstart-zig

PROJECT_NAME ?= raylib-quickstart-zig
BUILD_DIR = zig-out/bin

# Zig build command for WebAssembly
# We use -Dtarget=wasm32-emscripten to tell Zig to target Emscripten
# We assume emcc is in PATH and configured
ZIG = zig

# Get sysroot from emcc
SYSROOT := $(shell emcc --cflags | grep -o '\--sysroot=[^ ]*' | cut -d= -f2)

CC = emcc
# Linker flags for Emscripten + Raylib
# We link the static libraries generated by Zig
LDFLAGS = -Lzig-out/lib -l$(PROJECT_NAME) -lraylib
LDFLAGS += -s USE_GLFW=3 -s WASM=1 -s ALLOW_MEMORY_GROWTH=1 -s ASYNCIFY -s USE_WEBGL2=1
LDFLAGS += --preload-file resources
# LDFLAGS += --shell-file src/minshell.html # If you have one

.PHONY: all clean serve kill-port

all:
	@echo "Building $(PROJECT_NAME) for Web..."
	@if [ -z "$(SYSROOT)" ]; then echo "Error: Could not determine emcc sysroot"; exit 1; fi
	$(ZIG) build -Dtarget=wasm32-emscripten -Doptimize=ReleaseSmall -Dsysroot_path="$(SYSROOT)"
	@echo "Linking with emcc..."
	@mkdir -p $(BUILD_DIR)
	$(CC) -o $(BUILD_DIR)/$(PROJECT_NAME).html $(LDFLAGS)
	@echo "Build complete. Output in $(BUILD_DIR)"

clean:
	rm -rf zig-out zig-cache

serve: all kill-port
	@echo "Starting web server on http://localhost:8000"
	python3 -m http.server 8000 --directory $(BUILD_DIR)

kill-port:
	-lsof -t -i :8000 | xargs kill -9


